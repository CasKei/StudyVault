---
tags: #50.002
---
[[Comp Struct]]
[[Building Beta CPU]]

**Exceptions** as the name suggests, is an event generated by the CPU when an _error_ occurs.

Beta exceptions come in three flavors: ==traps==, ==faults==, and ==interrupts==.

1.  ==**Traps** (_intentional_) and **faults** (_unintentional_)== are both the **direct outcome of an instruction** and are distinguished by the programmer’s **intentions**.
    -   These happens for example when we supply an ==illegal== `OPCODE`, i.e: it does not correspond to any of the instructions defined in the ISA.
2.  ==**Interrupts**== are ==**asynchronous**== with respect to the instruction stream, and are usually ==caused by **external events**==, for example from I/O devices, or network devices. This would require us to “_pause_” the execution of the current program and handle the interrupt.
    -   At the beginning of each cycle, the CPU will always check whether `IRQ == 1`.
    -   If `IRQ != 1`, the CPU will continue with normal execution.
    -   If `IRQ == 1`, the CPU will _pause_ the current execution and handle the interrupt request first (and eventually _resume_ back the paused execution _after the interrupt handling is done_).

The datapath that handles **trap/fault** (due to Illegal `OPCODE`) is as follows:
![[Pasted image 20220221092518.png]]

The datapath that handles **interrupt** (due to asynchronous `IRQ` signal) is as follows:
![[Pasted image 20220221092550.png]]
==There’s only one difference between the two: the datapath at the PCSEL mux.==

The PCSEL multiplexer’s fourth and fifth input are called `ILLOP` and `XAdr`. These refers to the address of the **instruction branching** to the **`interrupt handling`** code, in the events that trap, fault, or interrupt occurs. In beta ISA,

-   `ILLOP` is set at `0x80000004`
-   `XAdr` is set at `0x80000008`

The control signals in the events of these exceptions therefore must be set to:

-   `ALUFN = --`
    
    > We aren’t using the [[Anatomy of the Beta CPU#ALU|ALU]] at all when transferring control.
    
-   `WERF = 1`
-   `BSEL = --`
-   `WDSEL = 00`
-   `WR = 0`
-   `RA2SEL = --`
-   `PCSEL`:
    -   `Illegal_Opcode ? 011 : 000`
    -   `IRQ ? 100 : 000`
-   `ASEL = --`
-   `WASEL = 1`

Note that since `WASEL = 1` and `WDSEL = 00` and `WERF = 1`,, then `PC+4` (supposed next instruction’s address) is **stored** at `Reg[XP]` (register 28, or `11100` in binary) so that we may resume the execution once the exception has been handled.